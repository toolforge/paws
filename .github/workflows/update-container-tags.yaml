name: update container tags

on:
  pull_request_target:

jobs:
  update-container-tags:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          repository: 'dipietrom/paws'

      - name: git fetch
        run: |
          git fetch

      - name: git branch
        run: |
          git branch -a
      - name: git status
        run: |
          git status
      - name: git checkout
        run: |
          git checkout fork-to-test-secret
      - name: git status
        run: |
          git status
#      - name: github.action
#        run: echo ${{ github.action }}
#      - name: github.action_path
#        run: echo ${{ github.action_path }}
#      - name: github.actor
#        run: echo ${{ github.actor }}
#      - name: github.base_ref
#        run: echo ${{ github.base_ref }}
#      - name: github.event
#        run: echo ${{ github.event }}
#      - name: github.event_name
#        run: echo ${{ github.event_name }}
#      - name: github.event_path
#        run: echo ${{ github.event_path }}
#      - name: github.head_ref
#        run: echo ${{ github.head_ref }}
#      - name: github.job
#        run: echo ${{ github.job }}
#      - name: github.ref
#        run: echo ${{ github.ref }}
#      - name: github.ref_name
#        run: echo ${{ github.ref_name }}
#      - name: github.ref_protected
#        run: echo ${{ github.ref_protected }}
#      - name: github.ref_type
#        run: echo ${{ github.ref_type }}
#      - name: github.repository
#        run: echo ${{ github.repository }}
#      - name: github.repository_owner
#        run: echo ${{ github.repository_owner }}
#      - name: github.run_id
#        run: echo ${{ github.run_id }}
#      - name: github.run_number
#        run: echo ${{ github.run_number }}
#      - name: github.run_attempt
#        run: echo ${{ github.run_attempt }}
#      - name: github.server_url
#        run: echo ${{ github.server_url }}
#      - name: github.sha
#        run: echo ${{ github.sha }}
#      - name: github.token
#        run: echo ${{ github.token }}
#      - name: github.workflow
#        run: echo ${{ github.workflow }}
#      - name: github.workspace
#        run: echo ${{ github.workspace }}

#      - name: git github
#        run: echo ${{ !github }}
#      - name: git repository
#        run: echo ${{ github.repository }}
#      - name: git repository_owner
#        run: echo ${{ github.repository_owner }}
#      - name: git headref
#        run: echo ${{ github.head_ref }}
#      - name: git ref
#        run: echo ${{ github.ref }}
#      - name: git refname
#        run: echo ${{ github.ref_name }}
#      - name: git refprotected
#        run: echo ${{ github.ref_protected }}
#      - name: git reftype
#        run: echo ${{ github.ref_type }}
#      - name: git baseref
#        run: echo ${{ github.base_ref }}
# Github actions doesn't have much in the way of loops. Using a matrix results
# in multiple separate jobs being run, which will try to overwrite one another.
# Any kind of loop shaped thing would be more elegant than this. Until then,
# when a container is added copy one of these and change then name in all four
# places
      - name: update values.yaml for renderer
        run: |
          if [[ $(git diff remotes/origin/master -- images/renderer/) ]]; then
          sed -i 's/tag: .* # renderer tag managed by github actions$/tag: pr-${{ github.event.number }} # renderer tag managed by github actions/' paws/values.yaml
          fi

      - name: update values.yaml for nbserve
        run: |
          if [[ $(git diff remotes/origin/master -- images/nbserve/) ]]; then
          sed -i 's/tag: .* # nbserve tag managed by github actions$/tag: pr-${{ github.event.number }} # nbserve tag managed by github actions/' paws/values.yaml
          fi

      - name: update values.yaml for paws-hub
        run: |
          if [[ $(git diff remotes/origin/master -- images/paws-hub/) ]]; then
          sed -i 's/tag: .* # paws-hub tag managed by github actions$/tag: pr-${{ github.event.number }} # paws-hub tag managed by github actions/' paws/values.yaml
          fi

      - name: update values.yaml for jobber
        run: |
          if [[ $(git diff remotes/origin/master -- images/jobber/) ]]; then
          sed -i 's/tag: .* # jobber tag managed by github actions$/tag: pr-${{ github.event.number }} # jobber tag managed by github actions/' paws/values.yaml
          fi

      - name: update values.yaml for singleuser
        run: |
          if [[ $(git diff remotes/origin/master -- images/singleuser/) ]]; then
          sed -i 's/tag: .* # singleuser tag managed by github actions$/tag: pr-${{ github.event.number }} # singleuser tag managed by github actions/' paws/values.yaml
          fi

      - name: print values.yaml
        run: |
          cat paws/values.yaml

      - name: echo secret
        run: |
          echo ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - uses: EndBug/add-and-commit@v7
        with:
          add: 'paws/values.yaml'
          author_name: Github Action
          author_email: auto@github.com
          branch: ${{ github.head_ref }}
          message: 'auto update of ${{ inputs.imagename }} tag'
          pull: --rebase --autostash
